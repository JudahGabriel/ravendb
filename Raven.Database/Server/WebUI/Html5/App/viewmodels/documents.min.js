define(["require","exports","durandal/app","durandal/system","models/database","models/collection","models/document","common/raven","common/pagedList"],function(n,t,i,r,u,f,e,o,s){var c=i,l=r,y=u,h=f,p=e,a=o,v=s;return function(){function n(){var n=this;this.displayName="documents",this.collections=ko.observableArray(),this.selectedCollection=ko.observable().subscribeTo("ActivateCollection"),this.collectionColors=[],this.collectionsLoadedTask=$.Deferred(),this.collectionDocumentsLoaded=0,this.currentCollectionPagedItems=ko.observable(),this.deleteConfirmationText=ko.observable(""),this.ravenDb=new a,this.ravenDb.collections().then(function(t){return n.collectionsLoaded(t)}),this.selectedCollection.subscribe(function(t){return n.onSelectedCollectionChanged(t)})}return n.prototype.collectionsLoaded=function(n){var t=this,r=7,i;n.forEach(function(n,t){return n.colorClass="collection-style-"+t%r}),this.allDocumentsCollection=new h("All Documents"),this.allDocumentsCollection.colorClass="all-documents-collection",this.allDocumentsCollection.documentCount=ko.computed(function(){return t.collections().filter(function(n){return n!==t.allDocumentsCollection}).map(function(n){return n.documentCount()}).reduce(function(n,t){return n+t},0)}),i=[this.allDocumentsCollection].concat(n),this.collections(i),this.allDocumentsCollection.activate(),n.forEach(function(n){return t.fetchTotalDocuments(n)}),ko.postbox.subscribe("DeleteItems",function(n){return t.showDeletePrompt(n)})},n.prototype.fetchTotalDocuments=function(n){var t=this;this.ravenDb.collectionInfo(n.name).then(function(i){n.documentCount(i.totalResults),t.collectionDocumentsLoaded++,t.collectionDocumentsLoaded===t.collections().length-1&&t.collectionsLoadedTask.resolve()})},n.prototype.onSelectedCollectionChanged=function(n){var t=this,i,r;h&&(i=function(i,r){var u=n!==t.allDocumentsCollection?n.name:null;return t.ravenDb.documents(u,i,r)},r=new v(i,30),this.currentCollectionPagedItems(r))},n.prototype.activate=function(){return this.collectionsLoadedTask},n.prototype.showDeletePrompt=function(n){this.deleteCallback=n.callback,this.itemsToDelete=n.items,this.deleteConfirmationText(n.items.length===1?"You're deleting "+n.items[0].__metadata.id:"You're deleting "+n.items.length+" documents."),$("#ConfirmationDiv").slideDown("fast")},n.prototype.confirmDelete=function(){var t=this,i,n;this.deleteCallback&&this.itemsToDelete&&(i=this.itemsToDelete.map(function(n){return n.__metadata.id}),n=this.ravenDb.deleteDocuments(i),n.done(function(){t.deleteCallback()}),n.fail(function(n){l.log("Failed to delete items",n),c.showMessage("An error occurred deleting the item(s). The error has been logged.",":-(")}),n.always(function(){t.dismissDeleteConfirmation()}))},n.prototype.dismissDeleteConfirmation=function(){$("#ConfirmationDiv").hide(),$(".datatable").click()},n}()})