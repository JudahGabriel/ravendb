define(["require","exports","models/database","models/collection","models/document","common/raven","common/pagedList"],function(n,t,i,r,u,f,e){var c=i,o=r,l=u,s=f,h=e;return function(){function n(){var n=this;this.displayName="documents",this.collections=ko.observableArray(),this.selectedCollection=ko.observable().subscribeTo("ActivateCollection"),this.collectionColors=[],this.collectionsLoadedTask=$.Deferred(),this.collectionDocumentsLoaded=0,this.currentCollectionPagedItems=ko.observable(),this.ravenDb=new s,this.ravenDb.collections().then(function(t){return n.collectionsLoaded(t)}),this.selectedCollection.subscribe(function(t){return n.onSelectedCollectionChanged(t)}),ko.postbox.subscribe("RequestCollectionMembershipColorClass",function(t){return n.fetchCollectionColorClass(t)})}return n.prototype.collectionsLoaded=function(n){var t=this,r=7,i;n.forEach(function(n,t){return n.colorClass="collection-style-"+t%r}),this.allDocumentsCollection=new o("All Documents"),this.allDocumentsCollection.colorClass="all-documents-collection",this.allDocumentsCollection.documentCount=ko.computed(function(){return t.collections().filter(function(n){return n!==t.allDocumentsCollection}).map(function(n){return n.documentCount()}).reduce(function(n,t){return n+t},0)}),i=[this.allDocumentsCollection].concat(n),this.collections(i),this.allDocumentsCollection.activate(),n.forEach(function(n){return t.fetchTotalDocuments(n)})},n.prototype.fetchTotalDocuments=function(n){var t=this;this.ravenDb.collectionInfo(n.name).then(function(i){n.documentCount(i.totalResults),t.collectionDocumentsLoaded++,t.collectionDocumentsLoaded===t.collections().length-1&&t.collectionsLoadedTask.resolve()})},n.prototype.onSelectedCollectionChanged=function(n){var t=this,i,r;o&&(i=function(i,r){var u=n!==t.allDocumentsCollection?n.name:null;return t.ravenDb.documents(u,i,r)},r=new h(i,30),this.currentCollectionPagedItems(r))},n.prototype.fetchCollectionColorClass=function(n){console.log("fetching color for: ",n.item),n.colorClass="all-documents-collection"},n.prototype.activate=function(){return this.collectionsLoadedTask},n}()})