define(["require","exports","durandal/app","durandal/system","models/document","models/documentMetadata","common/raven"],function(n,t,i,r,u,f,e){var o=i,s=r,h=u,a=f,c=e,l=function(){function n(){var n=this;this.document=ko.observable(),this.ravenDb=new c,this.documentText=ko.computed(function(){return n.document()?n.stringify(n.document().toDto()):null}),this.metadata=ko.computed(function(){return n.document()?n.document().__metadata:null}),this.metadataText=ko.computed(function(){return n.metadata()?n.stringify(n.metadata().toDto()):null})}return n.prototype.activate=function(n){var i=this,t;if(n.id)return t=this.ravenDb.documentWithMetadata(n.id),t.done(function(n){return i.document(n)}),t.fail(function(t){return i.failedToLoadDoc(n.id,t)}),t},n.prototype.failedToLoadDoc=function(n,t){s.log("Failed to load document for editing.",t),o.showMessage("Can't edit '"+n+"'. Details logged in the browser console.",":-(",["Dismiss"])},n.prototype.saveDocument=function(){var n=JSON.parse(this.documentText()),t;n["@metadata"]=JSON.parse(this.metadataText()),t=new h(n),this.ravenDb.saveDocument(t).then(function(){return console.log("done saving!")})},n.prototype.stringify=function(n){return JSON.stringify(n,null,4)},n}();t.editDocument=l})