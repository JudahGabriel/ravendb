define(["require","exports","common/pagedList","models/document","models/collection","common/pagedResultSet"],function(n,t,i,r,u,f){var e=i,o=r,s=u,h=f;return function(){function n(n,t){var i=this;if(this.element=n,this.settings=t,this.rows=ko.observableArray(),this.columns=ko.observableArray(),this.isFirstRender=!0,this.skip=0,this.take=100,this.totalRowsCount=0,this.isContextMenuVisible=ko.observable(!1),this.contextMenuX=ko.observable(0),this.contextMenuY=ko.observable(0),!t.items||!ko.isObservable(t.items))throw new Error("datatable must be passed an items observable.");this.currentItemsCollection=this.settings.items,this.collections=this.settings.collections,this.selectionStack=[],this.memoizedColorClassForEntityName=this.getColorClassFromEntityName.memoize(this),this.fetchNextChunk(),this.allRowsChecked=ko.computed({read:function(){return i.rows().length>0&&i.rows().every(function(n){return n.isChecked()})},write:function(n){return i.rows().forEach(function(t){return t.isChecked(n)})}}),this.isLoading=ko.computed(function(){return i.currentItemsCollection()&&i.currentItemsCollection().isFetching()}),this.currentItemsCollection.subscribe(function(){i.rows.removeAll(),i.columns.removeAll(),i.fetchNextChunk(),i.selectionStack.length=0}),this.currentItemsCollection()&&this.fetchNextChunk(),$(".datatable tbody").contextmenu({target:"#context-menu"})}return n.prototype.fetchNextChunk=function(){var i=this,t=this.currentItemsCollection(),n;t&&(n=t.loadNextChunk(),n&&n.done(function(n){return i.nextChunkFetched(n)}))},n.prototype.nextChunkFetched=function(n){var t=this,i;this.totalRowsCount=n.totalResultCount,this.createCellsForColumns(this.rows(),this.getPropertyNames(n.items)),i=n.items.map(function(n){var i=t.columns().map(function(i){return t.createCell(t.getTemplateForCell(i,n),i,n,n[i])});return t.createRow(n,ko.observableArray(i))}),this.rows.pushAll(i)},n.prototype.getPropertyNames=function(n){var t=[];return n.forEach(function(n){for(var i in n)n.hasOwnProperty(i)&&i!=="__metadata"&&t.indexOf(i)==-1&&t.push(i)}),t},n.prototype.createCellsForColumns=function(n,t){var r=this,i=t.filter(function(n){return r.columns().indexOf(n)===-1&&n!=="Id"}).sort(function(n,t){return n==="Name"?-1:t==="Name"?1:n?n.localeCompare(t):t?t.localeCompare(n):0}),u;this.columns().length===0&&i.unshift("Id"),i.length>0&&(u=function(n){return i.map(function(t){return r.createCell("default-cell-template",t,n,"")})},this.columns.pushAll(i),n.forEach(function(n){return n.cells.pushAll(u(n))}))},n.prototype.selectOnRightClick=function(n,t){t.button===2&&(n.isChecked()||(n.isChecked(!0),this.selectionStack.push(n)))},n.prototype.toggleChecked=function(n,t){var i=this,r,e,f;if(n.isChecked(!n.isChecked()),r=this.rows.indexOf(n),n.isChecked()?this.selectionStack.unshift(n):(e=this.selectionStack.indexOf(n),e>=0&&this.selectionStack.splice(e,1)),t&&t.shiftKey&&this.selectionStack.length>1){var o=n.isChecked(),u=this.rows.indexOf(o?this.selectionStack[1]:this.selectionStack[0]),s=r>=0&&u>=0&&r!=u;s&&(f=this.rows.slice(Math.min(r,u),Math.max(r,u)),f.forEach(function(n){return n.isChecked(o)}),o===!0?f.filter(function(n){return i.selectionStack.indexOf(n)===-1}).forEach(function(n){return i.selectionStack.push(n)}):f.filter(function(n){return i.selectionStack.indexOf(n)!==-1}).forEach(function(n){return i.selectionStack.splice(i.selectionStack.indexOf(n),1)}))}},n.prototype.getTemplateForCell=function(n,t){if(n=="Id")return"colored-id-cell-template";if(t[n]){var i=t[n].toString().match(/\w+\/\d+/),r=i&&i[0]==t[n];if(r)return"id-cell-template"}return"default-cell-template"},n.prototype.toggleAllRowsChecked=function(){this.allRowsChecked(!this.allRowsChecked())},n.prototype.onLastRowVisible=function(){var n=this.rows().length<this.totalRowsCount;n&&!this.isLoading()&&this.fetchNextChunk()},n.prototype.afterRenderColumn=function(){var n=this;if(this.isFirstRender){this.isFirstRender=!1,$(".document-row:last-child").appear();$(window.document.body).on("appear",".document-row:last-child",function(){return n.onLastRowVisible()})}},n.prototype.createRow=function(n,t){return{data:n,cells:t,isChecked:ko.observable(!1)}},n.prototype.createCell=function(n,t,i,r){t==="Id"&&!r&&i&&!i.Id&&i.__metadata&&(r=i.__metadata.id),r&&typeof r=="object"&&(r=ko.toJSON(r));var u={colorClass:"",templateName:n,value:r};return t==="Id"&&(u.colorClass=this.memoizedColorClassForEntityName(i.__metadata.ravenEntityName)),u},n.prototype.getColorClassFromEntityName=function(n){for(var t=1;t<this.collections().length;t++)if(this.collections()[t].name===n)return this.collections()[t].colorClass},n.prototype.onKeyDown=function(n,t){t.which===46&&this.selectionStack.length>0&&(t.stopPropagation(),this.deleteSelection())},n.prototype.deleteSelection=function(){var i=this,n,t;this.selectionStack.length>0&&(n=this.selectionStack.map(function(n){return n.data}),t={items:n,callback:function(){return i.onItemsDeleted(n)}},ko.postbox.publish("DeleteItems",t))},n.prototype.editSelection=function(){var n=this.selectionStack.last(),t;n&&(t={item:n.data},ko.postbox.publish("EditItem",t))},n.prototype.onItemsDeleted=function(n){var t=this.rows().filter(function(t){return n.indexOf(t.data)>=0});this.rows.removeAll(t),this.selectionStack.removeAll(t)},n}()})