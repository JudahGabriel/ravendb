define(["require","exports","common/pagedList","models/document","models/collection","common/pagedResultSet"],function(n,t,i,r,u,f){var e=i,o=r,s=u,h=f;return function(){function n(n,t){var i=this;if(this.element=n,this.settings=t,this.rows=ko.observableArray(),this.columns=ko.observableArray(),this.selectionStack=[],this.isFirstRender=!0,this.skip=0,this.take=100,this.totalRowsCount=0,!t.items||!ko.isObservable(t.items))throw new Error("datatable must be passed an items observable.");this.currentItemsCollection=this.settings.items,this.collections=this.settings.collections,this.memoizedColorClassForEntityName=this.getColorClassFromEntityName.memoize(),this.fetchNextChunk(),this.allRowsChecked=ko.computed({read:function(){return i.rows().length>0&&i.rows().every(function(n){return n.isChecked()})},write:function(n){return i.rows().forEach(function(t){return t.isChecked(n)})}}),this.isLoading=ko.computed(function(){return i.currentItemsCollection()&&i.currentItemsCollection().isFetching()}),this.currentItemsCollection.subscribe(function(){i.rows.removeAll(),i.columns.removeAll(),i.fetchNextChunk()}),this.currentItemsCollection()&&this.fetchNextChunk(),$(window).resize(function(){return i.sizeTable()})}return n.prototype.sizeTable=function(){var n=$(this.element).find(".datatable"),r=$("footer"),t,i,u;n&&r&&(t=n.position(),i=r.position(),t&&i&&(u=70,n.height(i.top-t.top-u)))},n.prototype.fetchNextChunk=function(){var i=this,t=this.currentItemsCollection(),n;t&&(n=t.loadNextChunk(),n&&n.done(function(n){return i.nextChunkFetched(n)}))},n.prototype.nextChunkFetched=function(n){var t=this,i;this.totalRowsCount=n.totalResultCount,this.createCellsForColumns(this.rows(),this.getPropertyNames(n.items)),i=n.items.map(function(n){var i=t.columns().map(function(i){return t.createCell(t.getTemplateForCell(i,n),i,n,n[i])});return t.createRow(n,ko.observableArray(i))}),this.rows.pushAll(i)},n.prototype.getPropertyNames=function(n){var t=[];return n.forEach(function(n){for(var i in n)n.hasOwnProperty(i)&&i!=="__metadata"&&t.indexOf(i)==-1&&t.push(i)}),t},n.prototype.createCellsForColumns=function(n,t){var r=this,i=t.filter(function(n){return r.columns().indexOf(n)===-1&&n!=="Id"}).sort(function(n,t){return n==="Name"?-1:t==="Name"?1:n?n.localeCompare(t):t?t.localeCompare(n):0}),u;this.columns().length===0&&i.unshift("Id"),i.length>0&&(u=function(n){return i.map(function(t){return r.createCell("default-cell-template",t,n,"")})},this.columns.pushAll(i),n.forEach(function(n){return n.cells.pushAll(u(n))}))},n.prototype.toggleChecked=function(n,t){var i,u;if(n.isChecked(!n.isChecked()),i=this.rows.indexOf(n),n.isChecked()?this.selectionStack.unshift(n):(u=this.selectionStack.indexOf(n),u>=0&&this.selectionStack.splice(u,1)),t&&t.shiftKey&&this.selectionStack.length>1){var f=n.isChecked(),r=this.rows.indexOf(f?this.selectionStack[1]:this.selectionStack[0]),e=i>=0&&r>=0&&i!=r;e&&this.rows.slice(Math.min(i,r),Math.max(i,r)).forEach(function(n){return n.isChecked(f)})}},n.prototype.getTemplateForCell=function(n,t){if(n=="Id")return"colored-id-cell-template";if(t[n]){var i=t[n].toString().match(/\w+\/\d+/),r=i&&i[0]==t[n];if(r)return"id-cell-template"}return"default-cell-template"},n.prototype.toggleAllRowsChecked=function(){this.allRowsChecked(!this.allRowsChecked())},n.prototype.loadMoreIfNeeded=function(){if(!this.isLoading()&&this.rows().length<this.totalRowsCount){var n=$(this.element),i=n.position().top+n.height(),t=$(this.element).find(".document-row:last-child").position(),r=t&&t.top-200<i;r&&this.fetchNextChunk()}},n.prototype.afterRenderColumn=function(){var t=this,n;this.isFirstRender&&(n=$(this.element).find(".datatable"),n!=null&&(this.isFirstRender=!1,this.sizeTable(),n.scroll(function(){return t.loadMoreIfNeeded()})))},n.prototype.createRow=function(n,t){return{data:n,cells:t,isChecked:ko.observable(!1)}},n.prototype.createCell=function(n,t,i,r){t==="Id"&&!r&&i&&!i.Id&&i.__metadata&&(r=i.__metadata.id),r&&typeof r=="object"&&(r=ko.toJSON(r));var u={colorClass:"",templateName:n,value:r};return t==="Id"&&(u.colorClass=this.memoizedColorClassForEntityName(i.__metadata.ravenEntityName)),u},n.prototype.getColorClassFromEntityName=function(n){for(var t=1;t<this.collections().length;t++)if(this.collections()[t].name===n)return this.collections()[t].colorClass},n}()})