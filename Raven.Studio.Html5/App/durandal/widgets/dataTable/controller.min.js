define(["require","exports"],function(){return function(){function n(n,t){var i=this;this.element=n,this.settings=t,this.rows=ko.observableArray(),this.columns=ko.observableArray(),this.skip=0,this.take=100,this.totalRowsCount=0,this.isLoading=ko.observable(!1),this.selectionStack=[],this.isFirstRender=!0,this.fetchNextChunk(),this.allRowsChecked=ko.computed({read:function(){return i.rows().length>0&&i.rows().every(function(n){return n.isChecked()})},write:function(n){return i.rows().forEach(function(t){return t.isChecked(n)})}}),$(window).resize(function(){return i.sizeTable()})}return n.prototype.sizeTable=function(){var n=$(this.element).find(".datatable");if(n){var t=$("footer").position().top,i=n.position().top;n.height(t-i-80)}},n.prototype.fetchNextChunk=function(){var t=this,n;this.isLoading()||(this.isLoading(!0),n=this.createDummyResults(),setTimeout(function(){return t.nextChunkFetched({Items:n,TotalItems:342})},Math.random()*1e3))},n.prototype.nextChunkFetched=function(n){var t=this,i;this.totalRowsCount=n.TotalItems,this.createCellsForColumns(this.rows(),this.getPropertyNames(n.Items)),i=n.Items.map(function(n){var i=t.columns().map(function(i){return t.createCell(t.getTemplateForCell(i,n),n[i])});return t.createRow(ko.observableArray(i))}),this.streamInRows(i,function(){t.skip+=n.Items.length,t.isLoading(!1)})},n.prototype.getPropertyNames=function(n){var t=[];return n.forEach(function(n){for(var i in n)t.indexOf(i)==-1&&t.push(i)}),t},n.prototype.createCellsForColumns=function(n,t){var r=this,f=this.columns().length,i=t.filter(function(n){return r.columns().indexOf(n)===-1}),u;i.length>0&&(u=function(){return i.map(function(){return r.createCell("default-cell-template","")})},this.columns.pushAll(i),n.forEach(function(n){return n.cells.pushAll(u())}))},n.prototype.toggleChecked=function(n,t){var i,u;if(n.isChecked(!n.isChecked()),i=this.rows.indexOf(n),n.isChecked()?this.selectionStack.unshift(n):(u=this.selectionStack.indexOf(n),u>=0&&this.selectionStack.splice(u,1)),t&&t.shiftKey&&this.selectionStack.length>1){var f=n.isChecked(),r=this.rows.indexOf(f?this.selectionStack[1]:this.selectionStack[0]),e=i>=0&&r>=0&&i!=r;e&&this.rows.slice(Math.min(i,r),Math.max(i,r)).forEach(function(n){return n.isChecked(f)})}},n.prototype.getTemplateForCell=function(n,t){if(n=="Id")return"colored-id-cell-template";if(t[n]){var i=t[n].toString().match(/\w+\/\d+/),r=i&&i[0]==t[n];if(r)return"id-cell-template"}return"default-cell-template"},n.prototype.toggleAllRowsChecked=function(){this.allRowsChecked(!this.allRowsChecked())},n.prototype.loadMoreIfNeeded=function(){if(!this.isLoading()&&this.rows().length<this.totalRowsCount){var n=$(this.element),i=n.position().top+n.height(),t=$(this.element).find(".document-row:last-child").position(),r=t&&t.top-400<i;r&&this.fetchNextChunk()}},n.prototype.streamInRows=function(n,t){var i=this,r=n.splice(0,5);this.rows.pushAll(r),n.length>0?setTimeout(function(){return i.streamInRows(n,t)},1):t()},n.prototype.createDummyResults=function(){for(var r=[],t,i,n=0;n<this.take;n++)t=Math.random(),i=null,i=t<.2?{Id:"likes/"+(n+1),LikeStatus:t<.1?"Like":"Dislike",Date:"2013-01-22T23:29:03.1445000",SongId:"songs/"+(n+5),UserId:"users/"+(n+42)}:t<.4?{Id:"songs/"+(n+1),FileName:"aasdfasdf dwe",Name:"Habedesharie",Album:"Some Rand Album",AlbumArtUri:null,Artist:"The Beatles",CommunityRank:Math.floor(100*t)}:t<.6?{Id:"visits/"+(n+1),DateTime:"2013-01-22T23:29:03.1445000",TotalPlays:Math.floor(t*100),UserId:"users/"+(n+1)}:t<.8?{Id:"users/"+(n+1),ClientIdentifier:n+"2013-01-22T23:29:03.1445000",Preferences:"fasdf asdf asdfeqwerasdf eqwefasdfasdf",TotalPlays:Math.floor(t*1e3)}:{Id:"logs/"+n,Message:n+"qehqwet q asdfeqweerasdf eqwefasdfasdf",TimeStamp:"2013-01-22T23:29:03.1445000"},r.push(i);return r},n.prototype.afterRenderColumn=function(){var t=this,n;this.isFirstRender&&(n=$(this.element).find(".datatable"),n!=null&&(this.isFirstRender=!1,this.sizeTable(),n.scroll(function(){return t.loadMoreIfNeeded()})))},n.prototype.createRow=function(n){return{cells:n,isChecked:ko.observable(!1)}},n.prototype.createCell=function(n,t){return{templateName:n,value:t}},n}()})